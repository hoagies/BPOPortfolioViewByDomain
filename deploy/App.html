<!DOCTYPE html>
<html>
<head>
    <title>BPO Portfolio View by Domain</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("App.Constants",{singleton:!0,GRID_COLUMNS:4}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",title:"BPO Portfolio View by Domain",requires:["App.Constants"],launch:function(){this.add({xtype:"rallyownerfilter",itemId:"ownerComboBox",fieldLabel:"Initiative Owner:",stateful:!0,stateId:this.getContext().getScopedStateId("ownercombobox"),model:"PortfolioItem/Initiative",listeners:{select:this._onLoad,ready:this._onLoad,scope:this}})},_onLoad:function(){this.down("#container")&&this.down("#container").destroy();var panel=new Ext.Panel({id:"container",title:"Initiatives",layout:{type:"accordion",titleCollapse:!0,animate:!0,multi:!0},pack:"start",collapsible:!0,defaults:{bodyStyle:"padding:15px"}});this.add(panel);var initiativeStore=Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Initiative",pageSize:200,limit:1e4,autoLoad:!0,filters:[this._getOwnerFilter()],listeners:{load:function(store,data){this._onInitiativesLoaded(store,data)},scope:this}})},_onInitiativesLoaded:function(store,data){var that=this;Ext.Array.each(data,function(record){var id=record.get("FormattedID"),featureStore=Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Feature",pageSize:200,limit:1e4,autoLoad:!0,filters:[{property:"Parent.Parent.FormattedID",operator:"=",value:id}],listeners:{load:function(store,data){that._onFeaturesLoaded(store,record)},scope:this}})})},_onFeaturesLoaded:function(store,initiative){var projectNames=_.map(store.getRange(),function(record){return record.get("Project").Name}),uniqueProjectNames=_.uniq(projectNames),columns=App.Constants.GRID_COLUMNS,splitDomains=this._splitArray(uniqueProjectNames,columns),id=initiative.get("FormattedID"),title=id+" - "+initiative.get("Name"),panelChild=new Ext.Panel({title:title,layout:{type:"vbox",align:"stretch"},items:this._getItems(splitDomains,id)}),panel=this.down("#container");panel.add(panelChild),panel.doLayout()},_splitArray:function(unsplitArray,size){for(var splitArray=[];unsplitArray.length>0;)splitArray.push(unsplitArray.splice(0,size));return splitArray},_getItems:function(splitDomains,id){var gridRows=[],that=this;return Ext.Array.each(splitDomains,function(record){gridRows.push({xtype:"container",layout:{type:"hbox",align:"stretch"},height:175,frame:!0,align:"stretch",items:that._getItems2(record,id)})}),gridRows},_getItems2:function(records,id){var that=this,gridPanels=[];Ext.Array.each(records,function(record){gridPanels.push({title:record,flex:2,border:!0,autoScroll:!0,items:[{xtype:"rallygrid",header:!1,width:"95%",columnCfgs:[{text:"ID",dataIndex:"FormattedID",flex:10},{text:"State",dataIndex:"State",flex:10},{text:"% Done (pts)",dataIndex:"PercentDoneByStoryPlanEstimate",flex:10}],enableEditing:!1,showRowActionsColumn:!1,storeConfig:{model:"portfolioitem/feature",pageSize:500,filters:[that._getFilterGrid(record,id)]}}]})});for(var i=records.length;App.Constants.GRID_COLUMNS>i;)gridPanels.push({flex:2,border:!0}),i++;return gridPanels},_getFilterGrid:function(record,id){var combo=this.down("rallycombobox"),filters=Ext.create("Rally.data.QueryFilter",{property:"Parent.Parent.FormattedID",operator:"=",value:id});return filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"Project.Name",operator:"=",value:record}))},_getOwnerFilter:function(){combo=this.down("#ownerComboBox");var comboval=combo.getValue();return comboval||(comboval=combo.stateValue),(comboval+"").indexOf("-1")>-1&&(comboval=null),{property:"Owner",operator:"=",value:comboval}}});

            Rally.launchApp('CustomApp', {
                name:"BPO Portfolio View by Domain",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
